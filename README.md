# mp4frag
###### [![Build Status](https://travis-ci.org/kevinGodell/mp4frag.svg?branch=master)](https://travis-ci.org/kevinGodell/mp4frag) [![Build status](https://ci.appveyor.com/api/projects/status/n9emuydmqgf845v0/branch/master?svg=true)](https://ci.appveyor.com/project/kevinGodell/mp4frag/branch/master) [![GitHub issues](https://img.shields.io/github/issues/kevinGodell/mp4frag.svg)](https://github.com/kevinGodell/mp4frag/issues) [![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://raw.githubusercontent.com/kevinGodell/mp4frag/master/LICENSE) [![npm](https://img.shields.io/npm/dt/mp4frag.svg?style=flat-square)](https://www.npmjs.com/package/mp4frag)

###### [![NPM](https://nodei.co/npm/mp4frag.png?downloads=true&downloadRank=true&stars=true)](https://nodei.co/npm/mp4frag/)
Parser that works with ffmpeg to read piped data and fragment mp4 into an initialization segment and media segments. It can also get the codec info and generate an fmp4 HLS m3u8 playlist.
***Must use the following flags with ffmpeg targeting the output***: *-f mp4 -movflags +frag_keyframe+empty_moov+default_base_moof*.

[Documents](https://kevingodell.github.io/mp4frag/) generated by jsdocs.

Currently being used in:
* [Shinobi - Simple CCTV and NVR Solution](https://shinobi.video/)
* [Live Video Experience (LiVE)](https://video-experience.live/)  
* [ffmpeg-streamer](https://github.com/kevinGodell/ffmpeg-streamer)
* [node-red-contrib-mp4frag](https://github.com/kevinGodell/node-red-contrib-mp4frag)

# Breaking Changes
## Constructor options have changed
* `hlsBase` => `hlsPlaylistBase` _string_, accepts `_`, `a-z`, and `A-Z`
* `hlsSize` => `hlsPlaylistSize` _integer_, ranges from `2` to `20`, defaults to `4`
* `hlsInit` => `hlsPlaylistInit` _boolean_, defaults to `true`
* `bufferListSize` => `segmentCount` _integer_, ranges from `2` to `30`, defaults to `2` 
## Segment event has changed
```js
mp4frag.on('segment', data => {
  console.log(data);
});
```
* Previously, data was a Buffer containing a single segment.
* Currently, data is an object structured as `{ segment, sequence, duration, timestamp }`

# Options for a new instance of Mp4Frag

#### segmentCount: integer (2 - 30), *setting this value will store specified number of media segments in the buffer*
* will be ignored if setting `hlsPlaylistBase`
```javascript
const mp4frag = new Mp4Frag({segmentCount: 3});
```

#### hlsPlaylistBase: string (`_`, `a-z`, and `A-Z`), *setting this will generate a live fmp4 HLS m3u8 playlist*
#### hlsListSize: integer (2 - 20), *setting this will determine the number of segments in the fmp4 HLS m3u8 playlist*
```javascript
const mp4frag = new Mp4Frag({hlsPlaylistSize: 4, hlsPlaylistBase: 'my_String'});
```

# Possible usage examples

## Example 1: *Generate a live fmp4 HLS m3u8 playlist with ffmpeg*

```javascript
const { spawn } = require('child_process');

const Mp4Frag = require('mp4frag');

const mp4frag = new Mp4Frag({hlsPlaylistSize: 3, hlsPlaylistBase: 'back_yard'});

const ffmpeg = spawn(
    'ffmpeg',
    ['-loglevel', 'quiet', '-probesize', '64', '-analyzeduration', '100000', '-reorder_queue_size', '5', '-rtsp_transport', 'tcp', '-i', 'rtsp://216.4.116.29:554/axis-media/media.3gp', '-an', '-c:v', 'copy', '-f', 'mp4', '-movflags', '+frag_keyframe+empty_moov+default_base_moof', '-metadata', 'title="ip 216.4.116.29"', '-reset_timestamps', '1', 'pipe:1'],
    {stdio: ['ignore', 'pipe', 'inherit']}
);

ffmpeg.stdio[1].pipe(mp4frag);
   
```
  * **m3u8 playlist will now be available via `mp4frag.m3u8` and can be served to a client browser via express**
  * **segments in playlist can be accessed by sequence number via `mp4frag.getSegment(6)`, with `6` being the current sequence number**
#### Generated m3u8 playlist will look like the following example pulled from my live feed
```
#EXTM3U
#EXT-X-VERSION:7
#EXT-X-ALLOW-CACHE:NO
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:6
#EXT-X-MAP:URI="init-back_yard.mp4"
#EXTINF:4.780000,
back_yard6.m4s
#EXTINF:5.439000,
back_yard7.m4s
#EXTINF:4.269000,
back_yard8.m4s
```
#### Setting up some server routes to respond to http requests for playing live HLS feed
```javascript
app.get('/back_yard.m3u8', (req, res) => {
    if (mp4frag.m3u8) {
        res.writeHead(200, {'Content-Type': 'application/vnd.apple.mpegurl'});
        res.end(mp4frag.m3u8);
    } else {
        res.sendStatus(503);//todo maybe send 400
    }
});

app.get('/init-back_yard.mp4', (req, res) => {
    if (mp4frag.initialization) {
        res.writeHead(200, {'Content-Type': 'video/mp4'});
        res.end(mp4frag.initialization);
    } else {
        res.sendStatus(503);
    }
});

app.get('/back_yard:id.m4s', (req, res) => {
    const segment = mp4frag.getSegment(req.params.id);
    if (segment) {
        res.writeHead(200, {'Content-Type': 'video/mp4'});
        res.end(segment);
    } else {
        res.sendStatus(503);
    }
});
```
## Example 2: *Create a buffer of past video to store for later recording*

```javascript
const { spawn } = require('child_process');

const Mp4Frag = require('mp4frag');

//3 past segments will be held in buffer for later access via mp4frag.buffer
//if each segment has a duration of 2 seconds, then buffer will contain 6 seconds of video
const mp4frag = new Mp4Frag({segmentCount: 3});

const ffmpeg = spawn(
    'ffmpeg',
    ['-loglevel', 'quiet', '-probesize', '64', '-analyzeduration', '100000', '-reorder_queue_size', '5', '-rtsp_transport', 'tcp', '-i', 'rtsp://131.95.3.162:554/axis-media/media.3gp', '-an', '-c:v', 'copy', '-f', 'mp4', '-movflags', '+frag_keyframe+empty_moov+default_base_moof', '-metadata', 'title="ip 131.95.3.162"', '-reset_timestamps', '1', 'pipe:1'],
    {stdio: ['ignore', 'pipe', 'inherit']}
);

ffmpeg.stdio[1].pipe(mp4frag);
```
##### Moments later, some triggering event occurs such as motion detection, and we need to record buffered video from before the event occurred:

```javascript
const fs = require('fs');

const writeStream = fs.createWriteStream(`${Date.now()}.mp4`);

    //write the currently buffered Mp4 initialization fragment and media segments
    writeStream.write(mp4frag.buffer);
    
    //end
    writeStream.end();
```
